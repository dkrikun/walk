#!/bin/bash

target=$2
src=${2//.o/.c}

deps() {
  exec gcc -MM $src | ruby -e "obj, deps = STDIN.read.split(':'); deps.split(' ').each { |d| puts d }"
}

compile() {
  exec gcc -Wall -o $target -c $src
}

case $1 in
  deps) deps ;;
  exec)
    if ./changed "$target" "$(deps)"; then
      compile
    fi
    ;;
esac

#!/bin/bash

SOURCE=${2%.o}.c

deps() {
    gcc -MM $SOURCE | ruby -e "obj, deps = STDIN.read.split(':'); deps.split(' ').each { |d| puts d }"
}

case $1 in
  deps)
    deps ;;
  exec)
    object=$2
    # If any of the dependencies are newer than the object file, build it.
    for d in $(deps); do
      if [ "$d" -nt $object ]; then
        gcc -Wall -o $object -c $SOURCE
        exit
      fi
    done
esac

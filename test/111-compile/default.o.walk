#!/bin/bash

target=$2
src=${2//.o/.c}

deps() {
  gcc -MM $src | ruby -e "obj, deps = STDIN.read.split(':'); deps.split(' ').each { |d| puts d }"
}

# Returns true if any of the dependencies are newer than the object file.
changed() {
  if [[ ! -f "$target" ]]; then
    return 0
  elif [[ -n "$(find $(deps) -newer $target)" ]]; then
    return 0
  else
    return 1
  fi
}

compile() {
  gcc -Wall -o $target -c $src
}

case $1 in
  deps) deps ;;
  exec)
    if changed; then
      compile
    fi
    ;;
esac
